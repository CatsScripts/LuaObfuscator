<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonSecV3 LuaU Dumper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h3::before {
            content: "üîß";
            font-size: 1.2em;
        }

        textarea {
            width: 100%;
            height: 400px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8fafc;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .drop-zone {
            border: 3px dashed #cbd5e0;
            background: #f0f4ff;
            color: #667eea;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .secondary-btn {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .secondary-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-top: 5px;
        }

        .log {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 150px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-left: 3px solid transparent;
            padding-left: 8px;
        }

        .log-info { border-left-color: #4299e1; }
        .log-success { border-left-color: #48bb78; }
        .log-warning { border-left-color: #ed8936; }
        .log-error { border-left-color: #f56565; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .feature-badge {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin: 2px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls {
                justify-content: center;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MoonSecV3 LuaU Dumper</h1>
            <p>Advanced deobfuscation tool for MoonSec V3 protected Lua scripts</p>
            <div style="margin-top: 10px;">
                <span class="feature-badge">Pattern Recognition</span>
                <span class="feature-badge">Constant Extraction</span>
                <span class="feature-badge">Control Flow Analysis</span>
                <span class="feature-badge">String Decryption</span>
                <span class="feature-badge">File Drop Support</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="constantsFound">0</div>
                <div class="stat-label">Constants Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stringsDecrypted">0</div>
                <div class="stat-label">Strings Decrypted</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="functionsFound">0</div>
                <div class="stat-label">Functions Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="obfuscationLevel">0%</div>
                <div class="stat-label">Obfuscation Level</div>
            </div>
        </div>

        <div class="controls">
            <button class="primary-btn" onclick="dumpMoonSec()">üîç Analyze & Dump</button>
            <button class="secondary-btn" onclick="clearAll()">üßπ Clear All</button>
            <button class="secondary-btn" onclick="loadSample()">üìù Load Sample</button>
            <button class="secondary-btn" onclick="triggerFileUpload()">üìÅ Upload File</button>
            <button class="secondary-btn" onclick="downloadResult()">üíæ Download Result</button>
            <button class="secondary-btn" onclick="copyToClipboard()">üìã Copy Output</button>
            <button class="secondary-btn" onclick="checkOnlineResources()">üåê Online Resources</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h3>Input (Obfuscated Code)</h3>
                <textarea id="inputCode" placeholder="Paste your obfuscated MoonSec V3 LuaU code here...

Or drag and drop a .lua/.txt file to automatically load it!"></textarea>
            </div>
            
            <div class="panel">
                <h3>Output (Dumped/Deobfuscated)</h3>
                <textarea id="outputCode" placeholder="Deobfuscated code will appear here..." readonly></textarea>
            </div>
        </div>

        <div class="log" id="logOutput">
            <div class="log-entry log-info">MoonSecV3 Dumper initialized. Ready to analyze obfuscated code.</div>
        </div>
    </div>

    <script>
        let analysisResults = {
            constants: [],
            strings: [],
            functions: [],
            patterns: [],
            variables: []
        };

        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function updateStats() {
            document.getElementById('constantsFound').textContent = analysisResults.constants.length;
            document.getElementById('stringsDecrypted').textContent = analysisResults.strings.length;
            document.getElementById('functionsFound').textContent = analysisResults.functions.length;
            
            const input = document.getElementById('inputCode').value;
            const obfuscationLevel = calculateObfuscationLevel(input);
            document.getElementById('obfuscationLevel').textContent = obfuscationLevel + '%';
        }

        function calculateObfuscationLevel(code) {
            if (!code) return 0;
            
            let score = 0;
            const totalChars = code.length;
            
            // Count various obfuscation indicators
            const indicators = {
                hexEscapes: (code.match(/\\x[0-9a-fA-F]{2}/g) || []).length * 2,
                stringChar: (code.match(/string\.char\(/g) || []).length * 5,
                shortVars: (code.match(/\bv\d+\b/g) || []).length * 1,
                localAssigns: (code.match(/local\s+[a-zA-Z_]\w*\s*=/g) || []).length * 1,
                tableAccess: (code.match(/\[[^\]]+\]/g) || []).length * 1,
                loadstring: (code.match(/loadstring/g) || []).length * 10,
                getfenv: (code.match(/getfenv/g) || []).length * 8,
                tonumber: (code.match(/tonumber/g) || []).length * 1,
                gsub: (code.match(/gsub/g) || []).length * 3
            };
            
            Object.values(indicators).forEach(count => score += count);
            
            return Math.min(100, Math.floor((score / totalChars) * 1000));
        }

        async function dumpMoonSec() {
            const input = document.getElementById('inputCode').value;
            if (!input.trim()) {
                log('No input code provided!', 'error');
                return;
            }

            log('Starting MoonSec V3 analysis...', 'info');
            updateProgress(5);
            
            // Reset results
            analysisResults = {
                constants: [],
                strings: [],
                functions: [],
                patterns: [],
                variables: []
            };

            try {
                // Step 1: Extract constants and patterns
                log('Phase 1: Extracting constants and variables...', 'info');
                await sleep(100);
                await extractConstants(input);
                updateProgress(20);
                
                // Step 2: Extract variables
                log('Phase 2: Analyzing variable patterns...', 'info');
                await sleep(100);
                await extractVariables(input);
                updateProgress(35);
                
                // Step 3: Decrypt strings
                log('Phase 3: Decrypting obfuscated strings...', 'info');
                await sleep(100);
                await decryptStrings(input);
                updateProgress(55);
                
                // Step 4: Analyze control flow
                log('Phase 4: Analyzing control flow and functions...', 'info');
                await sleep(100);
                await analyzeControlFlow(input);
                updateProgress(75);
                
                // Step 5: Detect MoonSec patterns
                log('Phase 5: Detecting MoonSec specific patterns...', 'info');
                await sleep(100);
                await detectMoonSecPatterns(input);
                updateProgress(90);
                
                // Step 6: Generate cleaned output
                log('Phase 6: Generating deobfuscated code...', 'info');
                await sleep(100);
                const cleaned = await generateCleanedCode(input);
                updateProgress(100);
                
                document.getElementById('outputCode').value = cleaned;
                updateStats();
                log('‚úÖ Analysis complete! Code has been deobfuscated.', 'success');
                log(`üìä Summary: ${analysisResults.constants.length} constants, ${analysisResults.strings.length} strings, ${analysisResults.functions.length} functions processed`, 'success');
                
                setTimeout(() => updateProgress(0), 3000);
                
            } catch (error) {
                log(`‚ùå Error during analysis: ${error.message}`, 'error');
                updateProgress(0);
            }
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function extractConstants(code) {
            // Extract local variable assignments
            const localVars = code.match(/local\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*([^;\n\r]+)/g) || [];
            localVars.forEach(match => {
                const parts = match.match(/local\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*([^;\n\r]+)/);
                if (parts && parts[1] && parts[2]) {
                    analysisResults.constants.push({
                        name: parts[1],
                        value: parts[2].trim(),
                        type: 'local_assignment'
                    });
                }
            });
            
            // Extract table assignments
            const tableAssigns = code.match(/([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*\{[^}]*\}/g) || [];
            tableAssigns.forEach(match => {
                const parts = match.match(/([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*(\{[^}]*\})/);
                if (parts && parts[1] && parts[2]) {
                    analysisResults.constants.push({
                        name: parts[1],
                        value: parts[2],
                        type: 'table_assignment'
                    });
                }
            });
            
            log(`Found ${analysisResults.constants.length} constants`, 'info');
        }

        async function extractVariables(code) {
            // Extract common MoonSec variable patterns (v0, v1, etc.)
            const moonSecVars = code.match(/\bv\d+\b/g) || [];
            const uniqueVars = [...new Set(moonSecVars)];
            
            uniqueVars.forEach(varName => {
                // Try to find what this variable is assigned to
                const assignmentPattern = new RegExp(`local\\s+${varName}\\s*=\\s*([^;\\n\\r]+)`);
                const match = code.match(assignmentPattern);
                if (match) {
                    analysisResults.variables.push({
                        name: varName,
                        assignment: match[1].trim(),
                        type: 'moonsec_var'
                    });
                }
            });
            
            log(`Identified ${uniqueVars.length} MoonSec variables`, 'info');
        }

        async function decryptStrings(code) {
            // Extract hex encoded strings
            const hexStrings = code.match(/\\x[0-9a-fA-F]{2}/g) || [];
            const uniqueHex = [...new Set(hexStrings)];
            
            uniqueHex.forEach(hex => {
                try {
                    const char = String.fromCharCode(parseInt(hex.slice(2), 16));
                    if (char.match(/[a-zA-Z0-9 .,!?'"]/)) { // Only readable chars
                        analysisResults.strings.push({
                            original: hex,
                            decoded: char,
                            type: 'hex_escape'
                        });
                    }
                } catch (e) {
                    // Skip invalid hex
                }
            });
            
            // Extract string.char patterns
            const charPatterns = code.match(/string\.char\([^)]+\)/g) || [];
            charPatterns.forEach(pattern => {
                try {
                    const nums = pattern.match(/\d+/g) || [];
                    if (nums.length > 0 && nums.length <= 50) { // Reasonable length
                        const decoded = nums.map(n => {
                            const num = parseInt(n);
                            return (num >= 32 && num <= 126) ? String.fromCharCode(num) : '';
                        }).join('');
                        
                        if (decoded.length > 0) {
                            analysisResults.strings.push({
                                original: pattern,
                                decoded: decoded,
                                type: 'string_char'
                            });
                        }
                    }
                } catch (e) {
                    // Skip invalid patterns
                }
            });
            
            // Extract byte patterns
            const bytePatterns = code.match(/string\.byte\([^)]+\)/g) || [];
            log(`Found ${bytePatterns.length} string.byte patterns`, 'info');
            
            log(`Decrypted ${analysisResults.strings.length} string patterns`, 'info');
        }

        async function analyzeControlFlow(code) {
            // Extract function definitions
            const functions = code.match(/(?:local\s+)?function\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\([^)]*\)/g) || [];
            functions.forEach(func => {
                const name = func.match(/function\s+([a-zA-Z_][a-zA-Z0-9_]*)/);
                if (name && name[1]) {
                    analysisResults.functions.push({
                        name: name[1],
                        signature: func,
                        type: 'function_def'
                    });
                }
            });
            
            // Extract anonymous functions assigned to variables
            const anonFuncs = code.match(/([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*function\s*\([^)]*\)/g) || [];
            anonFuncs.forEach(func => {
                const name = func.match(/([a-zA-Z_][a-zA-Z0-9_]*)\s*=/);
                if (name && name[1]) {
                    analysisResults.functions.push({
                        name: name[1],
                        signature: func,
                        type: 'anon_function'
                    });
                }
            });
            
            log(`Found ${analysisResults.functions.length} function definitions`, 'info');
        }

        async function detectMoonSecPatterns(code) {
            const patterns = [];
            
            // Check for common MoonSec indicators
            if (code.includes('getfenv') || code.includes('setfenv')) {
                patterns.push('Environment manipulation detected');
            }
            
            if (code.includes('loadstring')) {
                patterns.push('Dynamic code loading detected');
            }
            
            if (code.match(/v\d+\s*=\s*tonumber/)) {
                patterns.push('Number conversion obfuscation');
            }
            
            if (code.match(/v\d+\s*=\s*string\./)) {
                patterns.push('String manipulation obfuscation');
            }
            
            if (code.includes('math.ldexp')) {
                patterns.push('Mathematical obfuscation detected');
            }
            
            if (code.match(/pcall.*function/)) {
                patterns.push('Protected call obfuscation');
            }
            
            analysisResults.patterns = patterns;
            log(`Detected ${patterns.length} MoonSec obfuscation patterns`, 'info');
        }

        async function generateCleanedCode(code) {
            let cleaned = code;
            
            // Replace hex strings with readable characters
            analysisResults.strings.forEach(str => {
                if (str.type === 'hex_escape' && str.decoded.length === 1) {
                    const escaped = str.original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    cleaned = cleaned.replace(new RegExp(escaped, 'g'), `"${str.decoded}"`);
                }
            });
            
            // Replace string.char patterns with actual strings
            analysisResults.strings.forEach(str => {
                if (str.type === 'string_char' && str.decoded.length > 0) {
                    const escaped = str.original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    cleaned = cleaned.replace(new RegExp(escaped, 'g'), `"${str.decoded}"`);
                }
            });
            
            // Add comprehensive header with analysis results
            let output = `--[[\n`;
            output += `  MoonSecV3 LuaU Dumper - Analysis Report\n`;
            output += `  =====================================\n`;
            output += `  Timestamp: ${new Date().toLocaleString()}\n`;
            output += `  \n`;
            output += `  Analysis Results:\n`;
            output += `  - Constants found: ${analysisResults.constants.length}\n`;
            output += `  - Strings decrypted: ${analysisResults.strings.length}\n`;
            output += `  - Functions identified: ${analysisResults.functions.length}\n`;
            output += `  - Variables mapped: ${analysisResults.variables.length}\n`;
            output += `  - Obfuscation level: ${calculateObfuscationLevel(code)}%\n`;
            output += `  \n`;
            
            if (analysisResults.patterns.length > 0) {
                output += `  Detected Patterns:\n`;
                analysisResults.patterns.forEach(pattern => {
                    output += `  - ${pattern}\n`;
                });
                output += `  \n`;
            }
            
            if (analysisResults.variables.length > 0) {
                output += `  Variable Mappings (first 10):\n`;
                analysisResults.variables.slice(0, 10).forEach(v => {
                    output += `  - ${v.name} = ${v.assignment}\n`;
                });
                output += `  \n`;
            }
            
            output += `--]]\n\n`;
            
            // Add the cleaned code
            output += cleaned;
            
            return output;
        }

        function clearAll() {
            document.getElementById('inputCode').value = '';
            document.getElementById('outputCode').value = '';
            document.getElementById('logOutput').innerHTML = '<div class="log-entry log-info">üîÑ Cleared all content. Ready for new analysis.</div>';
            analysisResults = { constants: [], strings: [], functions: [], patterns: [], variables: [] };
            updateStats();
            updateProgress(0);
        }

        function loadSample() {
            const sampleCode = `-- MoonSec V3 Sample (Heavily Obfuscated)
local v0 = tonumber;
local v1 = string.byte;
local v2 = string.char;
local v3 = string.sub;
local v4 = string.gsub;
local v5 = string.rep;
local v6 = table.concat;
local v7 = table.insert;
local v8 = math.ldexp;
local v9 = getfenv or function()
    return _ENV;
end;
local v10 = setmetatable;
local v11 = pcall;
local v12 = select;
local v13 = unpack or table.unpack;
local v14 = tonumber;

local function v15(v16, v17, ...)
    local v18 = 1;
    local v19;
    v16 = v4(v3(v16, 5), "\\x2E", function(v30)
        if (v1(v30, 2) == 79) then
            local v78 = 0;
            while true do
                if (v78 == 0) then
                    v19 = v0(v3(v30, 1, 1));
                    return "";
                end
            end
        else
            local v79 = v2(v0(v30, 16));
            if v19 then
                local v85 = v5(v79, v19);
                v19 = nil;
                return v85;
            else
                return v79;
            end
        end
    end);
    
    local function v20(v31, v32, v33)
        if v33 then
            local v80 = (v31 / (2 ^ (v32 - 1))) % (2 ^ (((v33 - 1) - (v32 - 1)) + 1));
            return v80 - (v80 % 1);
        else
            local v81 = 2 ^ (v32 - 1);
            return (((v31 % (v81 + v81)) >= v81) and 1) or 0;
        end
    end;
    
    -- Encrypted string data
    local v21 = string.char(72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100);
    local v22 = "\\x48\\x65\\x6C\\x6C\\x6F";
    
    print(v21); -- Should decode to "Hello World"
    
    return loadstring(v16)(v17, ...);
end

-- Test function
local function test()
    local message = string.char(84, 101, 115, 116, 105, 110, 103);
    return message;
end`;
            
            document.getElementById('inputCode').value = sampleCode;
            log('üìù Sample MoonSec V3 obfuscated code loaded', 'info');
        }

        function downloadResult() {
            const output = document.getElementById('outputCode').value;
            if (!output.trim()) {
                log('‚ö†Ô∏è No output to download!', 'warning');
                return;
            }
            
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deobfuscated_moonsec_${Date.now()}.lua`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üíæ Deobfuscated code downloaded successfully', 'success');
        }

        async function copyToClipboard() {
            const output = document.getElementById('outputCode').value;
            if (!output.trim()) {
                log('‚ö†Ô∏è No output to copy!', 'warning');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(output);
                log('üìã Output copied to clipboard', 'success');
            } catch (err) {
                log('‚ùå Failed to copy to clipboard', 'error');
            }
        }

        // File drop functionality
        function setupFileDropZone() {
            const inputTextarea = document.getElementById('inputCode');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                inputTextarea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                inputTextarea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                inputTextarea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                inputTextarea.classList.add('drop-zone');
            }
            
            function unhighlight(e) {
                inputTextarea.classList.remove('drop-zone');
            }
            
            inputTextarea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
            
            function handleFiles(files) {
                if (files.length === 0) return;
                
                const file = files[0];
                
                if (!file.name.match(/\.(lua|txt|luau)$/i)) {
                    log('‚ö†Ô∏è Please drop a .lua, .luau, or .txt file', 'warning');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    inputTextarea.value = e.target.result;
                    log(`üìÅ File "${file.name}" loaded successfully (${file.size} bytes)`, 'success');
                    updateStats();
                };
                reader.onerror = function() {
                    log('‚ùå Error reading file', 'error');
                };
                reader.readAsText(file);
            }
        }
        
        // Additional file input button
        function createFileInput() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.lua,.txt,.luau';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('inputCode').value = e.target.result;
                        log(`üìÅ File "${file.name}" loaded via file picker`, 'success');
                        updateStats();
                    };
                    reader.readAsText(file);
                }
            });
            
            return fileInput;
        }

        // Advanced MoonSec pattern detection
        function detectAdvancedPatterns(code) {
            const advancedPatterns = [];
            
            // Check for bytecode manipulation
            if (code.match(/string\.dump/)) {
                advancedPatterns.push('Bytecode manipulation detected');
            }
            
            // Check for metamethod abuse
            if (code.match(/__index|__newindex|__call/)) {
                advancedPatterns.push('Metamethod obfuscation detected');
            }
            
            // Check for coroutine usage
            if (code.match(/coroutine\./)) {
                advancedPatterns.push('Coroutine-based obfuscation');
            }
            
            // Check for debug library usage
            if (code.match(/debug\./)) {
                advancedPatterns.push('Debug library manipulation');
            }
            
            // Check for constant folding patterns
            if (code.match(/\d+\s*[\+\-\*\/]\s*\d+/)) {
                advancedPatterns.push('Constant folding obfuscation');
            }
            
            // Check for table.concat patterns
            if (code.match(/table\.concat.*\{[^}]*\}/)) {
                advancedPatterns.push('Table concatenation obfuscation');
            }
            
            return advancedPatterns;
        }

        // Enhanced string decryption for complex patterns
        function decryptComplexStrings(code) {
            const complexStrings = [];
            
            // Handle table.concat string construction
            const concatPatterns = code.match(/table\.concat\s*\(\s*\{[^}]+\}/g) || [];
            concatPatterns.forEach(pattern => {
                try {
                    // Extract the array content
                    const arrayMatch = pattern.match(/\{([^}]+)\}/);
                    if (arrayMatch) {
                        const elements = arrayMatch[1].split(',').map(s => s.trim());
                        let decoded = '';
                        
                        elements.forEach(element => {
                            // Check if it's a string.char call
                            if (element.match(/string\.char\(\d+\)/)) {
                                const num = element.match(/\d+/);
                                if (num) {
                                    decoded += String.fromCharCode(parseInt(num[0]));
                                }
                            } else if (element.match(/^["'].*["']$/)) {
                                // Regular string literal
                                decoded += element.slice(1, -1);
                            }
                        });
                        
                        if (decoded) {
                            complexStrings.push({
                                original: pattern,
                                decoded: decoded,
                                type: 'table_concat'
                            });
                        }
                    }
                } catch (e) {
                    // Skip invalid patterns
                }
            });
            
            return complexStrings;
        }

        // Variable name beautification
        function beautifyVariableNames(code) {
            const variableMap = new Map();
            let varCounter = 0;
            
            // Map common MoonSec variables to meaningful names
            const commonMappings = {
                'v0': 'tonumber_func',
                'v1': 'string_byte',
                'v2': 'string_char',
                'v3': 'string_sub',
                'v4': 'string_gsub',
                'v5': 'string_rep',
                'v6': 'table_concat',
                'v7': 'table_insert',
                'v8': 'math_ldexp',
                'v9': 'getfenv_func',
                'v10': 'setmetatable_func',
                'v11': 'pcall_func',
                'v12': 'select_func',
                'v13': 'unpack_func',
                'v14': 'tonumber_func2'
            };
            
            let beautified = code;
            
            Object.entries(commonMappings).forEach(([original, replacement]) => {
                const regex = new RegExp(`\\b${original}\\b`, 'g');
                beautified = beautified.replace(regex, replacement);
            });
            
            return beautified;
        }

        // Export functionality with different formats
        function exportResults(format = 'lua') {
            const output = document.getElementById('outputCode').value;
            if (!output.trim()) {
                log('‚ö†Ô∏è No output to export!', 'warning');
                return;
            }
            
            let exportContent = output;
            let filename = `deobfuscated_moonsec_${Date.now()}`;
            let mimeType = 'text/plain';
            
            switch (format) {
                case 'json':
                    const analysisData = {
                        timestamp: new Date().toISOString(),
                        original_size: document.getElementById('inputCode').value.length,
                        deobfuscated_size: output.length,
                        analysis_results: analysisResults,
                        deobfuscated_code: output
                    };
                    exportContent = JSON.stringify(analysisData, null, 2);
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
                case 'txt':
                    filename += '.txt';
                    break;
                default:
                    filename += '.lua';
                    break;
            }
            
            const blob = new Blob([exportContent], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log(`üì§ Results exported as ${format.toUpperCase()}`, 'success');
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter to analyze
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    dumpMoonSec();
                }
                
                // Ctrl+Shift+C to clear
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    clearAll();
                }
                
                // Ctrl+S to download
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    downloadResult();
                }
                
                // Ctrl+Shift+V to load sample
                if (e.ctrlKey && e.shiftKey && e.key === 'V') {
                    e.preventDefault();
                    loadSample();
                }
            });
        }

        // Real-time analysis preview
        function setupRealTimeAnalysis() {
            const inputTextarea = document.getElementById('inputCode');
            let analysisTimeout;
            
            inputTextarea.addEventListener('input', function() {
                clearTimeout(analysisTimeout);
                analysisTimeout = setTimeout(() => {
                    updateStats();
                    
                    const code = inputTextarea.value;
                    if (code.length > 100) {
                        // Quick pattern detection for preview
                        const quickPatterns = [];
                        if (code.includes('string.char')) quickPatterns.push('String obfuscation');
                        if (code.match(/v\d+/)) quickPatterns.push('Variable obfuscation');
                        if (code.includes('loadstring')) quickPatterns.push('Dynamic loading');
                        if (code.includes('getfenv')) quickPatterns.push('Environment manipulation');
                        
                        if (quickPatterns.length > 0) {
                            log(`üîç Quick scan: ${quickPatterns.join(', ')}`, 'info');
                        }
                    }
                }, 1000);
            });
        }

        // Enhanced initialization
        function initializeDumper() {
            log('üöÄ MoonSecV3 Dumper initialized', 'info');
            log('üí° Tip: Use Ctrl+Enter to analyze, Ctrl+S to download', 'info');
            log('üìÅ Drag & drop .lua files or use the file picker', 'info');
            
            // Setup all functionality
            setupFileDropZone();
            setupKeyboardShortcuts();
            setupRealTimeAnalysis();
            updateStats();
            
            // Add file picker button
            const fileInput = createFileInput();
            document.body.appendChild(fileInput);
            
            // Add click handler to input area for file picker
            const inputTextarea = document.getElementById('inputCode');
            inputTextarea.addEventListener('click', function(e) {
                if (e.ctrlKey) {
                    fileInput.click();
                }
            });
        }

        // Initialize everything when the page loads
        window.addEventListener('DOMContentLoaded', initializeDumper);
        
        // Add some utility functions for advanced analysis
        window.moonSecUtils = {
            exportAsJSON: () => exportResults('json'),
            exportAsTXT: () => exportResults('txt'),
            beautifyNames: function() {
                const input = document.getElementById('inputCode').value;
                const beautified = beautifyVariableNames(input);
                document.getElementById('inputCode').value = beautified;
                log('‚ú® Variable names beautified', 'success');
            },
            detectAdvanced: function() {
                const input = document.getElementById('inputCode').value;
                const patterns = detectAdvancedPatterns(input);
                if (patterns.length > 0) {
                    patterns.forEach(pattern => log(`üî¨ ${pattern}`, 'info'));
                } else {
                    log('üî¨ No advanced patterns detected', 'info');
                }
            }
        };
        
        // Simple file upload trigger
        function triggerFileUpload() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.lua,.txt,.luau,.js,.ts';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        log('‚ö†Ô∏è File too large! Please use files under 5MB', 'warning');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('inputCode').value = e.target.result;
                        log(`üìÅ File "${file.name}" uploaded successfully (${formatFileSize(file.size)})`, 'success');
                        updateStats();
                        
                        // Quick analysis preview
                        const code = e.target.result;
                        const quickAnalysis = performQuickAnalysis(code);
                        if (quickAnalysis.length > 0) {
                            log(`üîç Quick scan: ${quickAnalysis.join(', ')}`, 'info');
                        }
                    };
                    reader.onerror = function() {
                        log('‚ùå Error reading file', 'error');
                    };
                    reader.readAsText(file);
                }
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Quick analysis for uploaded files
        function performQuickAnalysis(code) {
            const patterns = [];
            
            if (code.includes('string.char')) patterns.push('String obfuscation');
            if (code.match(/v\d+\s*=/)) patterns.push('Variable obfuscation');
            if (code.includes('loadstring')) patterns.push('Dynamic loading');
            if (code.includes('getfenv')) patterns.push('Environment manipulation');
            if (code.match(/\\x[0-9a-fA-F]{2}/)) patterns.push('Hex encoding');
            if (code.includes('tonumber')) patterns.push('Number conversion');
            if (code.includes('string.byte')) patterns.push('Byte manipulation');
            if (code.match(/table\.concat/)) patterns.push('Table concatenation');
            
            // Check for different obfuscation types
            if (code.includes('MoonSec')) patterns.push('MoonSec detected');
            if (code.includes('Ironbrew')) patterns.push('Ironbrew detected');
            if (code.includes('PSU')) patterns.push('PSU detected');
            if (code.includes('Synapse')) patterns.push('Synapse detected');
            
            return patterns;
        }

        // Check online resources function
        async function checkOnlineResources() {
            log('üåê Checking online deobfuscation resources...', 'info');
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 700px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            `;
            
            modalContent.innerHTML = `
                <h2 style="margin-bottom: 20px; color: #4a5568;">üåê Online Deobfuscation Resources</h2>
                
                <div style="display: grid; gap: 15px;">
                    <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px;">
                        <h3 style="margin-bottom: 10px; color: #667eea;">üêô GitHub Repositories</h3>
                        <button onclick="window.open('https://github.com/search?q=lua+deobfuscator', '_blank')" 
                                style="width: 100%; padding: 10px; margin-bottom: 5px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            Search Lua Deobfuscators
                        </button>
                        <button onclick="window.open('https://github.com/search?q=moonsec+dumper', '_blank')" 
                                style="width: 100%; padding: 10px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            MoonSec Dumpers
                        </button>
                    </div>
                    
                    <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px;">
                        <h3 style="margin-bottom: 10px; color: #ed8936;">üìö Learning Resources</h3>
                        <button onclick="window.open('https://stackoverflow.com/questions/tagged/lua+obfuscation', '_blank')" 
                                style="width: 100%; padding: 10px; margin-bottom: 5px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            StackOverflow - Lua Obfuscation
                        </button>
                        <button onclick="window.open('https://www.reddit.com/r/ReverseEngineering/', '_blank')" 
                                style="width: 100%; padding: 10px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            r/ReverseEngineering
                        </button>
                    </div>
                    
                    <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px;">
                        <h3 style="margin-bottom: 10px; color: #38a169;">üõ†Ô∏è Online Tools</h3>
                        <button onclick="window.open('https://www.unluac.net/', '_blank')" 
                                style="width: 100%; padding: 10px; margin-bottom: 5px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            UnLuaC - Lua Decompiler
                        </button>
                        <button onclick="window.open('https://beautifier.io/lua/', '_blank')" 
                                style="width: 100%; padding: 10px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            Lua Code Beautifier
                        </button>
                    </div>
                    
                    <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px;">
                        <h3 style="margin-bottom: 10px; color: #9f7aea;">üìñ Documentation</h3>
                        <button onclick="window.open('https://www.lua.org/manual/', '_blank')" 
                                style="width: 100%; padding: 10px; margin-bottom: 5px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            Official Lua Manual
                        </button>
                        <button onclick="window.open('https://luau.org/', '_blank')" 
                                style="width: 100%; padding: 10px; border: none; border-radius: 5px; background: #f7fafc; cursor: pointer;">
                            Luau Documentation
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                    <button onclick="closeResourceModal()" 
                            style="padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 20px; background: white; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            window.closeResourceModal = function() {
                document.body.removeChild(modal);
            };
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeResourceModal();
                }
            });
            
            log('üìö Online resources panel opened', 'success');
        }
    </script>
</body>
</html>
